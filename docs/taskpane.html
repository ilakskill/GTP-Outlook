<!DOCTYPE html>
<html>
  <head>
    <title>GPT Email Helper</title>
    <style>
      body {
          background-color: #f7f7f7;
          font-family: Arial, sans-serif;
      }

      form {
          display: flex;
          flex-direction: column;
          gap: 1rem;
          margin: 1rem;
          padding: 1rem;
          border: 1px solid #ddd;
          border-radius: 0.5rem;
          background-color: #fff;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      label {
          font-weight: bold;
          font-size: 1.1rem;
          color: #333;
          margin-bottom: 0.5rem;
      }

      input,
      textarea,
      select {
          padding: 0.5rem;
          border-radius: 0.25rem;
          border: 1px solid #ccc;
          font-size: 1rem;
          color: #333;
          background-color: #fff;
          box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
          transition: all 0.2s ease-in-out;
      }

      input:focus,
      textarea:focus,
      select:focus {
          outline: none;
          border: 1px solid #0078d4;
          box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1), 0 0 5px rgba(0, 120, 212, 0.5);
      }

      button {
          padding: 0.5rem;
          border-radius: 0.25rem;
          background-color: #0078d4;
          color: #fff;
          font-weight: bold;
          border: none;
          cursor: pointer;
          transition: all 0.2s ease-in-out;
      }

      button:hover {
          background-color: #005a9e;
      }

      hr {
          margin: 2rem 0;
          border: none;
          border-top: 1px solid #ddd;
      }

      .response {
          background-color: #f2f2f2;
          padding: 20px;
          border: 1px solid #e6e6e6;
          border-radius: 5px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
          margin-top: 2rem;
      }

      .response__role {
          color: #707070;
          font-size: 12px;
          margin-bottom: 10px;
      }

      .response__content {
          padding: 10px;
          font-size: 16px;
          line-height: 1.5;
          background-color: #fff;
          border: 1px solid #e6e6e6;
          border-radius: 5px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

<body>
  <form id="apikey-form">
    <div>
      <label for="apikey">API Key:</label>
      <input id="apikey" name="apikey" type="text" required />
    </div>

    <div>
      <label for="mainPrompts">Main Prompts</label>
      <div>
        <input id="mainPrompts" name="mainPrompts" required type="text" />
      </div>
    </div>

    <div>
      <label for="instructions-content">Instructions</label>
      <div>
        <textarea
          id="instructions-content"
          name="instructions-content"
        ></textarea>
      </div>
    </div>

    <button type="submit">Submit</button>
  </form>

  <hr />
  <div id="response"></div>

  <script
    src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
    type="text/javascript"
  ></script>
  <script type="text/javascript">
    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }

    Office.onReady(function () {
      var item = Office.context.mailbox.item;

      const form = document.getElementById("apikey-form");

      form.addEventListener("submit", (event) => {
        event.preventDefault();

        let apiKey = document.getElementById("apikey").value.trim();

        if (!apiKey) {
          apiKey = getCookie("apiKey");
        }

        let mainPrompts = document.getElementById("mainPrompts").value.trim();
        let systemInstructions = document.getElementById("instructions-content").value.trim();

        item.getSelectedDataAsync("text", function (result) {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            var selectedText = result.value;

            selectedText = JSON.stringify(selectedText);

            // Add a Message to the Thread
            const messagePayload = {
              role: "user",
              content: selectedText
            };

            const addMessageUrl = `https://api.openai.com/v1/threads/thread_YePlpYrkfWq6n9pyLqyAIJ4V/messages`;
            const headers = {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + apiKey,
              "OpenAI-Beta": "assistants=v2"
            };

            fetch(addMessageUrl, {
              method: "POST",
              headers,
              body: JSON.stringify(messagePayload),
            })
            .then(() => {
              // Create a Run
              const runPayload = {
                assistant_id: "asst_YB3yM3JSCXDCox1065tQOxau",
                instructions: mainPrompts + systemInstructions
              };

              const runUrl = `https://api.openai.com/v1/threads/thread_YePlpYrkfWq6n9pyLqyAIJ4V/runs`;

              fetch(runUrl, {
                method: "POST",
                headers,
                body: JSON.stringify(runPayload),
              })
              .then((response) => response.json())
              .then((data) => {
                // Poll for the completion of the run
                const pollUrl = `https://api.openai.com/v1/threads/thread_YePlpYrkfWq6n9pyLqyAIJ4V/runs/${data.id}`;

                function pollRunStatus() {
                  fetch(pollUrl, {
                    method: "GET",
                    headers,
                  })
                  .then((response) => response.json())
                  .then((data) => {
                    if (data.status === "completed") {
                      // Retrieve the assistant's response
                      const responseDiv = document.getElementById("response");
                      const assistantMessage = data.messages.find(msg => msg.role === "assistant").content;

                      const messageHTML = `
                        <div>
                          <div>Assistant:</div>
                          <div>${assistantMessage}</div>
                        </div>
                      `;

                      responseDiv.innerHTML = messageHTML;
                      copyToClipboard(assistantMessage);

                      const daysUntilExpiration = 30;
                      const expirationDate = new Date();
                      expirationDate.setDate(expirationDate.getDate() + daysUntilExpiration);

                      document.cookie = `apiKey=${apiKey}; expires=${expirationDate.toUTCString()}`;
                    } else {
                      setTimeout(pollRunStatus, 1000);
                    }
                  });
                }

                pollRunStatus();
              })
              .catch((error) => console.error(error));
            })
            .catch((error) => console.error(error));
          } else {
            console.error(result.error.message);
          }
        });
      });

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      const apiKey = getCookie("apiKey");

      if (apiKey) {
        document.getElementById("apikey").value = apiKey;
        document.getElementById("apikey").closest("div").setAttribute("style", "display: none");
      }
    });
  </script>

</body>
</html>
