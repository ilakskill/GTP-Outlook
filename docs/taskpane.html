<!DOCTYPE html>
<html>
  <head>
    <title>OpenAI API Test</title>
  </head>
  <body>
    <form id="apikey-form">
      <label for="apikey">API Key:</label>
      <input type="text" id="apikey" name="apikey" required />
      <textarea id="user-email-content" name="user-email-content"></textarea>
      <button type="submit">Submit</button>
    </form>
    <hr />
    <div id="response"></div>

    <script
      src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
      type="text/javascript"
    ></script>
    <script type="text/javascript">
      Office.onReady(() => {
        // Get the current email item
        var item = Office.context.mailbox.item;

        // Get the body of the email as plain text
        item.getSelectedDataAsync(Office.CoercionType.Text, function (result) {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            // The plain text body of the email is in result.value
            console.log(result.value);
          } else {
            console.error(result.error.message);
          }
        });

        const form = document.getElementById("apikey-form");
        form.addEventListener("submit", (event) => {
          event.preventDefault();
          const apiKey = document.getElementById("apikey").value.trim();
          const userEmailContent = document
            .getElementById("user-email-content")
            .value.trim();

          const payload = {
            messages: [
              {
                role: "system",
                content:
                  "Act like a project manager but do not state you are a project manager and respond to this email.",
              },
              { role: "user", content: userEmailContent },
            ],
            model: "gpt-3.5-turbo",
            max_tokens: 2048,
            temperature: 0.7,
            n: 1,
            stream: false,
          };

          const url = "https://api.openai.com/v1/chat/completions";
          const headers = {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey,
          };

          fetch(url, {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .then((data) => {
              const assistantMessage = data.choices[0].message.content;
              const responseDiv = document.getElementById("response");
              responseDiv.innerHTML = assistantMessage;
              document.cookie = `apiKey=${apiKey}`;
            })
            .catch((error) => console.error(error));
        });
      });
    </script>
  </body>
</html>
