<!DOCTYPE html>
<html>
<head>
    <title>GPT Email Helper.v2</title>
    <style>
        body {
            background-color: #f7f7f7;
            font-family: Arial, sans-serif;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        label {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #ccc;
            font-size: 1rem;
            color: #333;
            background-color: #fff;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border: 1px solid #0078d4;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1), 0 0 5px rgba(0, 120, 212, 0.5);
        }

        button {
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: #0078d4;
            color: #fff;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            background-color: #005a9e;
        }

        hr {
            margin: 2rem 0;
            border: none;
            border-top: 1px solid #ddd;
        }

        .response {
            background-color: #f2f2f2;
            padding: 20px;
            border: 1px solid #e6e6e6;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .response__role {
            color: #707070;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .response__content {
            padding: 10px;
            font-size: 16px;
            line-height: 1.5;
            background-color: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
<form id="apikey-form">
    <div>
        <label for="apikey">API Key:</label>
        <input id="apikey" name="apikey" type="text" required />
    </div>

    <div>
        <label for="mainPrompts">Main Prompts</label>
        <div>
            <input id="mainPrompts" name="mainPrompts" required type="text" />
        </div>
    </div>

    <div>
        <label for="instructions-content">Instructions</label>
        <div>
        <textarea
                id="instructions-content"
                name="instructions-content"
        ></textarea>
        </div>
    </div>

    <button type="submit">Submit</button>
</form>

<hr />
<div id="response"></div>

<script
        src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"
        type="text/javascript"
></script>

<script type="text/javascript">
    Office.onReady(function () {
        var item = Office.context.mailbox.item;
        const form = document.getElementById("apikey-form");
        const responseDiv = document.getElementById("response");

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            let apiKey = document.getElementById("apikey").value.trim();
            const mainPrompts = document.getElementById("mainPrompts").value.trim();
            const systemInstructions = document.getElementById("instructions-content").value.trim();
            displayProcessing(true);

            item.body.getAsync("text", async function (result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    let emailContent = result.value;
                    try {
                        // Create a new Thread for this email/draft
                        let thread = await createThread(apiKey, emailContent, mainPrompts + systemInstructions);
                        let runResult = await runAssistant(apiKey, thread.id);
                        displayResponse(runResult);
                        displayProcessing(false);
                    } catch (error) {
                        displayError(error);
                        displayProcessing(false);
                    }
                } else {
                    displayError("Failed to fetch email content.");
                    displayProcessing(false);
                }
            });
        });

        function displayProcessing(isProcessing) {
            const submitButton = document.querySelector("button[type='submit']");
            if (isProcessing) {
                submitButton.textContent = "Processing...";
                submitButton.disabled = true;
            } else {
                submitButton.textContent = "Submit";
                submitButton.disabled = false;
            }
        }


        function displayResponse(response) {
            responseDiv.innerHTML = `<div class="response__content">Response: ${response.choices[0].message.content}</div>`;
        }

        function displayError(error) {
            responseDiv.innerHTML = `<div class="response">Error: ${error.message}</div>`;
        }


        async function createThread(apiKey, emailContent, instructions) {
            const payload = {
                messages: [
                    {
                        role: "system",
                        content: instructions,
                    },
                    {
                        role: "user",
                        content: emailContent,
                    },
                ],
            };

            const response = await fetch("https://api.openai.com/v1/assistants/asst_yYDwQoJch0GXcxX430T8eluR/threads", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${apiKey}`,
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data; // Assuming this returns a thread object or ID
        }


        async function runAssistant(apiKey, threadId) {
            const response = await fetch(`https://api.openai.com/v1/assistants/asst_yYDwQoJch0GXcxX430T8eluR/threads/${threadId}/run`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${apiKey}`,
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data; // This should include the Assistant's response
        }

    });
</script>



</body>
</html>
